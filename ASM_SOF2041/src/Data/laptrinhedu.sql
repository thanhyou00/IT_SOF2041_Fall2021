CREATE DATABASE EDUSY
GO
USE EDUSY
GO

-- CREATE TABLE
CREATE TABLE CHUYENDE (
	MACD NCHAR(5) PRIMARY KEY NOT NULL,
	TENCD  NVARCHAR(50)  NOT NULL , 
	HOCPHI FLOAT NOT NULL,
	THOILUONG INT NOT NULL,
	HINH NVARCHAR(50)  NOT NULL ,
	MOTA NVARCHAR(255)  NOT NULL
)

CREATE TABLE NHANVIEN (
	MANV NVARCHAR(20) NOT NULL PRIMARY KEY,
	MATKHAU NVARCHAR(50) NOT NULL,
	HOTEN NVARCHAR(50) NOT NULL,
	VAITRO BIT NOT NULL DEFAULT 1,
)

 CREATE TABLE KHOAHOC (
	MAKH INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	MACD NCHAR(5) NOT NULL FOREIGN KEY REFERENCES CHUYENDE(MACD) ON DELETE NO ACTION ON UPDATE CASCADE,
	HOCPHI FLOAT NOT NULL DEFAULT 0,
	THOILUONG INT NOT NULL DEFAULT 0,
	NGAYKG	DATE NOT NULL,
	GHICHU NVARCHAR(50) NULL,
	MANV NVARCHAR(20) NOT NULL FOREIGN KEY REFERENCES NHANVIEN(MANV) ON DELETE NO ACTION ON UPDATE CASCADE,
	NGAYTAO DATE  NOT NULL DEFAULT GETDATE(),
	CHECK(HOCPHI >=0 AND THOILUONG >0)
 )
 CREATE TABLE NGUOIHOC (
	MANH NCHAR(7) NOT NULL PRIMARY KEY,
	HOTEN NVARCHAR(50) NOT NULL,
	GIOITINH BIT NOT NULL DEFAULT 1,
	NGAYSINH DATE NOT NULL,
	EMAIL NVARCHAR(50) NOT NULL,
	DIENTHOAI NVARCHAR(24) NOT NULL,
	GHICHU NVARCHAR(255) NULL,
	MANV NVARCHAR(20) NOT NULL FOREIGN KEY REFERENCES NHANVIEN(MANV) ON DELETE NO ACTION ON UPDATE CASCADE,
	NGAYDK DATE NOT NULL DEFAULT GETDATE(),
)
CREATE TABLE HOCVIEN (
	MAHV INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	MAKH INT NOT NULL FOREIGN KEY REFERENCES KHOAHOC(MAKH) ON DELETE CASCADE,
	MANH NCHAR(7) NOT NULL FOREIGN KEY REFERENCES NGUOIHOC(MANH) ON DELETE NO ACTION ON UPDATE CASCADE,
	DIEM FLOAT NOT NULL DEFAULT -1,
)

-- INSERT DATA

INSERT INTO CHUYENDE VALUES ('CD001',N'Chuyên đề Java',9000000,120,N'hinh01.jpg',N'Khó')
INSERT INTO CHUYENDE VALUES ('CD002',N'Chuyên đề HTML/CSS',8000000,120,N'hinh02.jpg',N'Dễ')
INSERT INTO CHUYENDE VALUES ('CD003',N'Chuyên đề C#',9000000,120,N'hinh03.jpg',N'Khó')
INSERT INTO CHUYENDE VALUES ('CD004',N'Chuyên đề C++',10000000,120,N'hinh04.jpg',N'Khó')
INSERT INTO CHUYENDE VALUES ('CD005',N'Chuyên đề Photoshop',6000000,100,N'hinh05.jpg',N'Dễ')

INSERT INTO NHANVIEN VALUES('NV001','mk00001',N'Nguyễn Văn Trức',1)
INSERT INTO NHANVIEN VALUES('NV002','mk00002',N'Bùi Thu Trang',1)
INSERT INTO NHANVIEN VALUES('NV003','mk00003',N'Trịnh Đình Quang',0)
INSERT INTO NHANVIEN VALUES('NV004','mk00004',N'Nguyễn Thị Thanh',0)
INSERT INTO NHANVIEN VALUES('NV005','mk00005',N'Nguyễn Văn Trung',1)

INSERT INTO KHOAHOC VALUES('CD001',9000000,120,'01/02/2000',N'Khó','NV001','01/01/1999')
INSERT INTO KHOAHOC VALUES('CD002',8000000,120,'06/08/2000',N'Dễ','NV002','01/01/1999')
INSERT INTO KHOAHOC VALUES('CD003',9000000,120,'05/02/2000',N'Khó','NV003','01/01/1999')
INSERT INTO KHOAHOC VALUES('CD004',10000000,120,'01/05/2000',N'Khó','NV004','01/01/1999')
INSERT INTO KHOAHOC VALUES('CD005',6000000,100,'01/08/2000',N'Dễ','NV005','01/01/1999')

INSERT INTO NGUOIHOC VALUES('NH001',N'Nguyễn Trức',1,'06/08/2000',N'truc@gmail.com','0326360127',N'Ghi 01','NV001','02/04/2002')
INSERT INTO NGUOIHOC VALUES('NH002',N'Nguyễn Thanh',0,'06/08/2002',N'thanh@gmail.com','0326360128',N'Ghi 02','NV002','03/04/2002')
INSERT INTO NGUOIHOC VALUES('NH003',N'Nguyễn Nam',1,'06/02/2001',N'nam@gmail.com','0326360129',N'Ghi 03','NV003','03/04/2002')
INSERT INTO NGUOIHOC VALUES('NH004',N'Nguyễn Trang',0,'01/05/2002',N'truc@gmail.com','0326360130',N'Ghi 04','NV004','02/04/2002')
INSERT INTO NGUOIHOC VALUES('NH005',N'Nguyễn Hùng',1,'02/02/2001',N'hung@gmail.com','0326360131',N'Ghi 05','NV005','02/04/2002')

INSERT INTO HOCVIEN VALUES(1,'NH001',10)
INSERT INTO HOCVIEN VALUES(2,'NH002',10)
INSERT INTO HOCVIEN VALUES(3,'NH003',9)
INSERT INTO HOCVIEN VALUES(4,'NH004',8.5)
INSERT INTO HOCVIEN VALUES(5,'NH005',10)


-- Create proc

-- Report : MANH - HOTEN - DIEM
CREATE PROC sp_Bangdiem
	@MAKH INT
AS BEGIN
	SELECT 
		nh.MANH,
		nh.HOTEN,
		hv.DIEM
	FROM HOCVIEN hv INNER JOIN NGUOIHOC nh ON hv.MANH = nh.MANH
	WHERE hv.MAKH = @MAKH
	ORDER BY hv.DIEM DESC
END
GO

-- Report : TENCD - SOHV - DIEMTN - DIEMCN - DIEMTB
CREATE PROC sp_Thongkediem
AS BEGIN 
	SELECT 
		TENCD AS TENCHUYENDE,
		COUNT(MAHV) AS SOHV,
		MIN(DIEM) AS DIEMTN,
		MAX(DIEM) AS DIEMCN,
		AVG(DIEM) AS DIEMTB
	FROM KHOAHOC kh
		INNER JOIN HOCVIEN hv ON kh.MAKH = hv.MAKH
		INNER JOIN CHUYENDE cd ON cd.MACD = kh.MACD
	GROUP BY TENCD
END
GO

-- Report : TENCD - SOHV - DOANHTHU - DTHUTN - DTHUCN - DTHUTB
CREATE PROC sp_Thongkedoanhthu
	@Year INT
AS BEGIN
	SELECT
		TENCD AS TENCHUYENDE,
		COUNT(DISTINCT kh.MAKH) AS SOKH,
		COUNT(hv.MAHV) AS SOHV,
		SUM(kh.HOCPHI) AS DOANHTHU,
		MIN(kh.HOCPHI) AS DTHUTN,
		MAX(kh.HOCPHI) AS DTHUCN,
		AVG(kh.HOCPHI) AS HPHITB
	FROM KHOAHOC kh
		INNER JOIN HOCVIEN hv ON kh.MAKH = hv.MAKH
		INNER JOIN CHUYENDE cd ON cd.MACD = kh.MACD
	WHERE YEAR(NGAYKG) = @Year
	GROUP BY TENCD
END
GO

-- Report : NAM - SOLUONG - NGHDAUTIEN - NGHCUOICUNG
CREATE PROC sp_Thongkenguoihoc
AS BEGIN
	SELECT 
		YEAR(NGAYDK) AS NAM,
		COUNT(*) AS SOLUONG,
		MIN(NGAYDK) AS DAUTIEN,
		MAX(NGAYDK) AS CUOICUNG
	FROM NGUOIHOC
	GROUP BY YEAR(NGAYDK)
END
GO


DROP TABLE CHUYENDE
DROP TABLE NHANVIEN
DROP TABLE KHOAHOC
DROP TABLE NGUOIHOC
DROP TABLE HOCVIEN

SELECT *FROM CHUYENDE
SELECT *FROM NHANVIEN
SELECT *FROM KHOAHOC 
SELECT *FROM NGUOIHOC
SELECT *FROM HOCVIEN

